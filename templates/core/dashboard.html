{% extends 'partials/base.html' %}
{% load static %}
{% block content %}

<style>
.dashboard-menu .nav-link {
    color: rgb(59, 183, 126); /* text color */
}

.dashboard-menu .nav-link.active {
    background-color: rgb(59, 183, 126); /* active background */
    color: #fff; /* active text */
}

.dashboard-menu .nav-link:hover {
    background-color: rgb(49, 153, 106); /* darker green on hover */
    color: #fff; /* text on hover */
}
</style>

<main class="main pages">
  <div class="page-header breadcrumb-wrap">
    <div class="container">
      <div class="breadcrumb">
       <a href="{% url 'core:dashboard' %}"><i class="fi-rs-home mr-5"></i>Home</a>
        <span></span> Dashboard
      </div>
    </div>
  </div>

  <div class="page-content pt-150 pb-150">
    <div class="container">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
          <div class="dashboard-menu">
            <ul class="nav flex-column nav-pills" id="dashboardTabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" href="#dashboard" role="tab">Dashboard</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="orders-tab" data-bs-toggle="pill" href="#orders" role="tab">Orders</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="profile-tab" data-bs-toggle="pill" href="#profile" role="tab">Profile</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="address-tab" data-bs-toggle="pill" href="#address" role="tab">My Address</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="shipment-tab" data-bs-toggle="pill" href="#shipment" role="tab">Following Shipment</a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Tab Content -->
        <div class="col-md-9">
          <div class="tab-content">

            <!-- Dashboard Map -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
              <div class="card">
                <div class="card-header">
                  <h3>Hello {{ request.user.username|title }}!</h3>
                </div>
                <div class="card-body">
                  <p>Your current car location:</p>
                  <div id="map" style="height: 500px;"></div>
                  <p id="current-latlng">Lat/Lng: loading...</p>
                  <p id="current-address">Address: loading...</p>
                </div>
              </div>
            </div>

            <!-- Orders -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
              <div class="card">
                <div class="card-header"><h3>Your Orders</h3></div>
                <div class="card-body">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Order</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for o in orders_list %}
                      <tr>
                        <td>{{ o.id }}</td>
                        <td>{{ o.order_date }}</td>
                        <td>{{ o.product_status|title }}</td>
                        <td>${{ o.price }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Profile -->
            <div class="tab-pane fade" id="profile" role="tabpanel">
              <div class="card">
                <div class="card-header"><h3>Profile</h3></div>
                <div class="card-body">
                  <p>Name: {{ user_profile.full_name }}</p>
                  <p>Phone: {{ user_profile.phone }}</p>
                  <p>Bio: {{ user_profile.bio }}</p>
                  {% if user_profile.verified %}
                    <p>Status: Verified <i class="fas fa-check-circle text-success"></i></p>
                  {% else %}
                    <p>Status: Not Verified <i class="fas fa-times text-danger"></i></p>
                  {% endif %}
                  <a href="{% url 'userauths:profile-update' %}" class="btn btn-success">Edit Profile</a>
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="tab-pane fade" id="address" role="tabpanel">
              <div class="card">
                <div class="card-header"><h3>My Addresses</h3></div>
                <div class="card-body">
                  <form method="POST">{% csrf_token %}
                    <input type="text" name="address" placeholder="Address" required>
                    <input type="text" name="mobile" placeholder="Phone" required>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </form>
                  <hr>
                  {% for a in address %}
                    <p>{{ a.address }} - {{ a.mobile }} {% if a.status %}(Default){% endif %}</p>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Following Shipment -->
            <div class="tab-pane fade" id="shipment" role="tabpanel">
              <div class="card">
                <div class="card-header"><h3>Following Shipment</h3></div>
                <div class="card-body">
                  <p>Track your shipments in real-time on the map below:</p>
                  <div id="shipment-map" style="height: 400px;"></div>
                  <ul id="shipment-list" class="mt-3">
                    {% for s in shipment_list %}
                      <li>Order {{ s.id }} - {{ s.status }} - Lat: {{ s.lat }}, Lng: {{ s.lng }}</li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Leaflet JS and CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Main car map
  const map = L.map('map').setView([0, 0], 15);
  L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=pbb2sew7SkM9L4WTtN44', {
    attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    tileSize: 512,
    zoomOffset: -1,
    crossOrigin: true
  }).addTo(map);

  const carIcon = L.icon({
    iconUrl: '{% static "assets/car.png" %}',
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });

  let carMarker;

  function updateCarLocation(lat, lng) {
    if (!carMarker) {
      carMarker = L.marker([lat, lng], {icon: carIcon}).addTo(map);
    } else {
      carMarker.setLatLng([lat, lng]);
    }
    map.setView([lat, lng], 15);
    document.getElementById('current-latlng').innerText = `Lat/Lng: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  }

  // Shipment map
  const shipmentMap = L.map('shipment-map').setView([0, 0], 2);
  L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=pbb2sew7SkM9L4WTtN44', {
    attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    tileSize: 512,
    zoomOffset: -1,
    crossOrigin: true
  }).addTo(shipmentMap);

  const shipmentMarkers = {};


  
  // WebSocket for real-time updates
  const ws = new WebSocket('ws://localhost:8000/ws/car_tracking/');
  ws.onmessage = function(event) {
    const data = JSON.parse(event.data);

    // Update main car map
    if(data.lat && data.lng){
      updateCarLocation(data.lat, data.lng);
    }

    // Update shipments on shipment map
    if(data.shipments){
      data.shipments.forEach(s => {
        if(shipmentMarkers[s.id]){
          shipmentMarkers[s.id].setLatLng([s.lat, s.lng]);
        } else {
          shipmentMarkers[s.id] = L.marker([s.lat, s.lng], {icon: carIcon}).addTo(shipmentMap);
        }
      });
    }
  };
</script>

{% endblock content %}
